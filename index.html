<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Werwolf-Spiel</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f0f0f0; }
        .container { text-align: center; max-width: 600px; margin: 50px auto; padding: 20px; border: 1px solid #ccc; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); background-color: white; }
        h1 { color: #4CAF50; }
        p { font-size: 1.2em; color: #555; }
        hr { margin: 30px auto; width: 50%; }
        button { font-size: 1.2em; padding: 10px 20px; cursor: pointer; border: none; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); margin-top: 15px; }
        .btn-green { background-color: #4CAF50; color: white; }
        .btn-blue { background-color: #008CBA; color: white; }
        .btn-red { background-color: #f44336; color: white; }
        .btn-info { font-size: 1em; margin-left: 10px; padding: 0 5px; width: 20px; height: 20px; border-radius: 50%; border: 1px solid #008CBA; background-color: #008CBA; color: white; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        
        /* Seitenansichten */
        .page { display: none; }
        .page.active { display: block; }

        /* Rollenseite */
        .role-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 5px 10px; border: 1px solid #ddd; border-radius: 5px; }
        .role-counter button { font-size: 1.2em; padding: 5px 10px; cursor: pointer; }

        /* Kartenansicht */
        #player-card { min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; border: 2px dashed #008CBA; border-radius: 10px; }
        #role-name { font-size: 1.5em; font-weight: bold; color: #f44336; }
        .btn-reveal-desc { font-size: 1em; padding: 8px 15px; background-color: #2196F3; color: white; }

        /* Übersicht */
        .player-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #ddd; cursor: pointer; text-align: left; }
        .dead-player { text-decoration: line-through; color: #888; }
        .player-item .info-btn { margin-right: 0; }
        
        /* Pop-up und Overlay */
        .info-popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; max-width: 400px; background: white; padding: 20px; border: 1px solid #ccc; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 1001; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; }
    </style>
</head>
<body>
    <div id="start-page" class="page active">
        <div class="container">
            <h1>Willkommen bei dem Werwolf-Spiel von Thomas.</h1>
            <p>Hier kannst du einfach die Rollen für dein Werwolf-Spiel verteilen und sie dir erklären lassen.</p>
            <hr>
            <button class="btn-green" onclick="showPage('names')">Zum Spiel</button>
        </div>
    </div>

    <div id="names-page" class="page">
        <div class="container">
            <h1>Namen eingeben</h1>
            <p>Gib die Namen der Spieler ein (jeder Name in einer neuen Zeile).</p>
            <textarea id="player-names-input" rows="10" cols="40"></textarea><br>
            <button class="btn-blue" onclick="savePlayersAndShowRoles()">Zu den Rollen</button>
        </div>
    </div>

    <div id="roles-page" class="page">
        <div class="container">
            <h1>Rollen auswählen</h1>
            <p>Wähle genau <span id="player-count"></span> Rollen aus.</p>
            <p style="font-size: 1.2em; color: #008CBA;">Noch zu vergeben: <span id="roles-to-go"></span></p>
            
            <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;">
                <button class="btn-red" onclick="showPage('names')">Zurück</button>
                <button id="start-button-top" class="btn-green" onclick="startGame()" style="display: none;">Mischen</button>
            </div>
            
            <div id="roles-list"></div>
            <button id="start-button-bottom" class="btn-green" onclick="startGame()" style="display: none;">Mischen</button>
        </div>
    </div>
    
    <div id="cards-page" class="page">
        <div class="container">
            <h1>Rollen aufdecken</h1>
            <div id="player-card">
                <h2 id="current-player-name"></h2>
                <p id="revealed-role-name" style="display: none;"></p>
                <p id="revealed-role-description" style="display: none;"></p>
                <button id="reveal-role-btn" class="btn-blue">Rolle aufdecken</button>
                <button id="show-description-btn" class="btn-reveal-desc" style="display: none;">Erklärung</button>
                <button id="next-player-btn" class="btn-blue" style="display: none;">Nächster Spieler</button>
            </div>
        </div>
    </div>

    <div id="overview-page" class="page">
        <div class="container">
            <h1>Spielübersicht</h1>
            <p>Hallo Spielleiter! Die Rollen wurden verteilt. Viel Spaß beim Spielen!</p>
            <p>Tippe auf den Namen, um einen ausgeschiedenen Spieler zu markieren.</p>
            
            <div id="player-list" style="text-align: left; margin: 20px auto; width: 80%;"></div>
            
            <button class="btn-red" onclick="restartGame()">Neustart</button>
            <button class="btn-green" onclick="goToHome()">Zur Startseite</button>
        </div>
    </div>

    <div id="info-popup" class="info-popup">
        <p id="popup-role-name" style="font-size: 1.5em; font-weight: bold; color: #008CBA; margin-bottom: 5px;"></p>
        <p id="popup-role-description" style="font-size: 0.9em; color: #555;"></p>
        <button onclick="hideInfo()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 2em; cursor: pointer;">&times;</button>
    </div>
    <div id="overlay" onclick="hideInfo()" class="overlay"></div>

    <script>
        const API_URL = 'https://werwolf-game.onrender.com/api';

        // Helper-Funktion für alle API-Aufrufe mit Credentials
        async function api(endpoint, data = null) {
            const options = {
                credentials: 'include'
            };

            if (data) {
                options.method = 'POST';
                options.headers = { 'Content-Type': 'application/json' };
                options.body = JSON.stringify(data);
            }

            const response = await fetch(API_URL + endpoint, options);
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || "Ein unbekannter Fehler ist aufgetreten.");
            }
            
            return result;
        }

        let ALL_ROLES_DESCRIPTIONS = {};
        let rolesCount = {};
        let totalPlayers = 0;
        let currentRoleData = null;
        let playerNamesList = [];

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId + '-page').classList.add('active');

            if (pageId === 'names') {
                loadPlayers();
            } else if (pageId === 'roles') {
                loadRoles();
            } else if (pageId === 'cards') {
                loadCard();
            } else if (pageId === 'overview') {
                loadOverview();
            }
        }

        // --- Startseite Logik ---
        function goToHome() {
            localStorage.clear();
            api('/game/restart_session', {}).finally(() => {
                showPage('start');
            });
        }

        // --- Namen-Seite Logik ---
        async function loadPlayers() {
            const savedPlayersString = localStorage.getItem('saved_players');
            if (savedPlayersString) {
                document.getElementById('player-names-input').value = savedPlayersString;
            }
        }

        async function savePlayersAndShowRoles() {
            const namenString = document.getElementById('player-names-input').value;
            playerNamesList = namenString.split('\n').map(name => name.trim()).filter(name => name !== '');
            localStorage.setItem('saved_players', namenString);

            if (playerNamesList.length === 0) {
                alert("Bitte gib zuerst die Namen der Spieler ein.");
                return;
            }

            try {
                await api('/game/save_players', { players: namenString });
                showPage('roles');
            } catch (error) {
                console.error("Fehler beim Speichern der Namen:", error);
                alert("Fehler beim Speichern der Namen. Bitte versuche es erneut.");
            }
        }

        // --- Rollen-Seite Logik ---
        async function loadRoles() {
            try {
                const data = await api('/game/get_players_and_roles_count');
                
                totalPlayers = data.player_count;
                ALL_ROLES_DESCRIPTIONS = data.all_roles;

                const savedRolesString = localStorage.getItem('saved_roles');
                if (savedRolesString) {
                    rolesCount = JSON.parse(savedRolesString);
                } else {
                    rolesCount = {};
                }

                if (totalPlayers === 0) {
                    showPage('names');
                    return;
                }

                document.getElementById('player-count').textContent = totalPlayers;
                
                const rolesList = document.getElementById('roles-list');
                rolesList.innerHTML = '';
                for (const role in ALL_ROLES_DESCRIPTIONS) {
                    const count = rolesCount[role] || 0;
                    rolesList.innerHTML += `
                        <div class="role-item">
                            <div style="display: flex; align-items: center;">
                                <span style="font-size: 1.1em; color: #333;">${role}</span>
                                <button onclick="showInfo('${role}')" class="btn-info">i</button>
                            </div>
                            <div class="role-counter">
                                <button onclick="decrementRole('${role}')">-</button>
                                <span id="${role}-count" style="font-size: 1.2em; margin: 0 10px;">${count}</span>
                                <button onclick="incrementRole('${role}')">+</button>
                            </div>
                        </div>
                    `;
                }
                updateRolesToGo();
            } catch (error) {
                console.error("Fehler beim Laden der Rollen:", error);
                document.getElementById('roles-list').innerHTML = '<p>Ein Fehler ist aufgetreten. Bitte versuche, die Seite neu zu laden oder zur Startseite zurückzukehren.</p>';
            }
        }

        function updateRolesToGo() {
            const totalRolesSelected = Object.values(rolesCount).reduce((a, b) => a + b, 0);
            const remainingRoles = totalPlayers - totalRolesSelected;
            document.getElementById("roles-to-go").textContent = remainingRoles;
            if (remainingRoles === 0) {
                document.getElementById("start-button-top").style.display = 'inline-block';
                document.getElementById("start-button-bottom").style.display = 'inline-block';
            } else {
                document.getElementById("start-button-top").style.display = 'none';
                document.getElementById("start-button-bottom").style.display = 'none';
            }
        }

        function incrementRole(role) {
            if (!rolesCount[role]) rolesCount[role] = 0;
            if (Object.values(rolesCount).reduce((a, b) => a + b, 0) < totalPlayers) {
                rolesCount[role]++;
                document.getElementById(role + '-count').textContent = rolesCount[role];
                updateRolesToGo();
                saveRoles();
            }
        }

        function decrementRole(role) {
            if (rolesCount[role] > 0) {
                rolesCount[role]--;
                document.getElementById(role + '-count').textContent = rolesCount[role];
                updateRolesToGo();
                saveRoles();
            }
        }

        async function saveRoles() {
            localStorage.setItem('saved_roles', JSON.stringify(rolesCount));
            try {
                await api('/game/save_roles', { 'role_counts': rolesCount });
            } catch (error) {
                console.error("Fehler beim Speichern der Rollen:", error);
            }
        }

        async function startGame() {
            try {
                const data = await api('/game/roles', { 'role_counts': rolesCount });
                showPage('cards');
            } catch (error) {
                alert(error.message);
            }
        }

        // --- Karten-Seite Logik ---
        async function loadCard() {
            try {
                const data = await api('/game/next_card');
                if (data.message) {
                    showPage('overview');
                } else {
                    document.getElementById('current-player-name').textContent = data.player_name;
                    document.getElementById('reveal-role-btn').style.display = 'inline-block';
                    document.getElementById('revealed-role-name').style.display = 'none';
                    document.getElementById('revealed-role-description').style.display = 'none';
                    document.getElementById('show-description-btn').style.display = 'none';
                    document.getElementById('next-player-btn').style.display = 'none';
                }
            } catch (error) {
                console.error("Fehler beim Laden der Karte:", error);
                showPage('names');
            }
        }

        async function revealCard() {
            try {
                const data = await api('/game/reveal_and_next', {});
                currentRoleData = data;
                document.getElementById('revealed-role-name').textContent = data.role_name;
                document.getElementById('revealed-role-name').style.display = 'block';
                document.getElementById('reveal-role-btn').style.display = 'none';
                document.getElementById('show-description-btn').style.display = 'inline-block';
                document.getElementById('next-player-btn').style.display = 'inline-block';
            } catch (error) {
                alert(error.message);
            }
        }

        function showDescription() {
            if (currentRoleData) {
                document.getElementById('revealed-role-description').textContent = currentRoleData.role_description;
                document.getElementById('revealed-role-description').style.display = 'block';
                document.getElementById('show-description-btn').style.display = 'none';
            }
        }

        // --- Übersichts-Seite Logik ---
        async function loadOverview() {
            try {
                const data = await api('/game/get_players_and_roles_count');
                ALL_ROLES_DESCRIPTIONS = data.all_roles;

                const playersData = await api('/gamemaster/view');

                const playerList = document.getElementById('player-list');
                playerList.innerHTML = '';
                
                if (playersData.length === 0) {
                    playerList.innerHTML = '<p>Keine Spieler gefunden. Bitte starte ein neues Spiel.</p>';
                } else {
                    playersData.forEach(player => {
                        const isDead = player.status === 'dead';
                        const infoBtn = `<button onclick="showInfo('${player.role}')" class="btn-info">i</button>`;
                        playerList.innerHTML += `
                            <div class="player-item ${isDead ? 'dead-player' : ''}">
                                <span onclick="killPlayer('${player.name}')" style="flex-grow: 1; display: flex; align-items: center;">
                                    <span style="font-weight: bold; margin-right: 5px;">${player.role}</span> | ${player.name}
                                </span>
                                ${infoBtn}
                            </div>
                        `;
                    });
                }
            } catch (error) {
                console.error(error);
                document.getElementById('player-list').innerHTML = `<p>Ein Fehler ist aufgetreten. Bitte kehre zur <a href="#" onclick="goToHome()">Startseite</a> zurück.</p>`;
            }
        }

        async function killPlayer(playerName) {
            const confirmKill = confirm(`Spieler '${playerName}' als 'tot' markieren?`);
            if (confirmKill) {
                try {
                    await api(`/gamemaster/kill/${playerName}`, {});
                    loadOverview();
                } catch (error) {
                    alert('Fehler beim Markieren des Spielers.');
                }
            }
        }

        async function restartGame() {
            try {
                const data = await api('/game/restart', {});
                alert(data.message);
                showPage('roles');
            } catch (error) {
                alert("Fehler beim Zurücksetzen des Spiels.");
            }
        }

        function showInfo(role) {
            const popup = document.getElementById('info-popup');
            const overlay = document.getElementById('overlay');
            document.getElementById('popup-role-name').textContent = role;
            document.getElementById('popup-role-description').textContent = ALL_ROLES_DESCRIPTIONS[role];
            popup.style.display = 'block';
            overlay.style.display = 'block';
        }

        function hideInfo() {
            document.getElementById('info-popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        document.getElementById('reveal-role-btn').addEventListener('click', revealCard);
        document.getElementById('show-description-btn').addEventListener('click', showDescription);
        document.getElementById('next-player-btn').addEventListener('click', loadCard);
        
        // Initialer Seitenaufruf
        document.addEventListener('DOMContentLoaded', () => {
            const savedPlayersString = localStorage.getItem('saved_players');
            if (savedPlayersString && savedPlayersString.trim().length > 0) {
                showPage('roles');
            } else {
                showPage('start');
            }
        });
    </script>
</body>
</html>