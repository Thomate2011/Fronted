<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Werwolf-Spiel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f0f0f0;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #4CAF50;
        }
        .start-button, .action-button, .back-button {
            font-size: 1.2em;
            padding: 10px 20px;
            cursor: pointer;
            color: white;
            border: none;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            text-decoration: none;
            display: inline-block;
        }
        .start-button {
            background-color: #4CAF50;
        }
        .action-button {
            background-color: #008CBA;
        }
        .back-button {
            background-color: #f44336;
        }
        .info-button {
            font-size: 1em;
            margin-left: 10px;
            padding: 0 5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid #008CBA;
            background-color: #008CBA;
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #roles-to-go.negative {
            color: #f44336;
        }
        .info-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 400px;
            background: white;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        .hidden {
            display: none !important;
        }
        textarea {
            width: 80%;
            padding: 10px;
            font-size: 1em;
        }
        .roles-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>

    <div id="start-page" class="container">
        <h1>Willkommen bei dem Werwolf-Spiel von Thomas.</h1>
        <p>Hier kannst du einfach die Rollen für dein Werwolf-Spiel verteilen und sie dir erklären lassen.</p>
        <hr>
        <button id="start-button" class="start-button">Zum Spiel</button>
    </div>

    <div id="players-page" class="container hidden">
        <h1>Namen eingeben</h1>
        <p>Gib die Namen der Spieler ein (jeder Name in einer neuen Zeile).</p>
        <textarea id="players-textarea" rows="10" cols="40"></textarea><br><br>
        <button id="to-roles-button" class="action-button">Zu den Rollen</button>
    </div>

    <div id="roles-page" class="container hidden">
        <h1>Rollen auswählen</h1>
        <p>Wähle genau die Anzahl der Spieler aus.</p>
        <p>Noch zu vergeben: <span id="roles-to-go"></span></p>

        <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;">
            <button id="back-to-players" class="back-button">Zurück</button>
            <button id="start-game-button" class="start-button hidden">Mischen</button>
        </div>

        <div id="roles-list"></div>
    </div>

    <div id="cards-page" class="container hidden">
        <h1>Rollen aufdecken</h1>
        <div id="player-card">
            <h2 id="player-name"></h2>
            <p id="role-name" class="hidden"></p>
            <p id="role-description" class="hidden"></p>
            <button id="reveal-role-btn" class="action-button">Rolle aufdecken</button>
            <button id="show-description-btn" class="action-button hidden">Erklärung</button>
            <button id="next-player-btn" class="start-button hidden">Nächster Spieler</button>
        </div>
    </div>

    <div id="neustart-page" class="container hidden">
        <h1>Spielübersicht</h1>
        <p>Tippe auf den Namen, um einen ausgeschiedenen Spieler zu entfernen.</p>
        <div id="player-list" style="text-align: left; margin: 20px auto; width: 80%;"></div>
        <button id="restart-game-btn" class="back-button">Neustart</button>
        <button id="start-page-btn" class="start-button">Zur Startseite</button>
    </div>

    <div id="info-popup" class="info-popup">
        <h2 id="popup-role-name"></h2>
        <p id="popup-role-description"></p>
        <button onclick="hideInfo()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 1.5em; cursor: pointer;">&times;</button>
    </div>
    <div id="overlay" class="overlay" onclick="hideInfo()"></div>

    <script>
        // API-URL
        const API_BASE_URL = window.location.origin.replace("werwolf-fronted", "werwolf-game");

        // Zustand
        let allPlayers = [];
        let allRolesData = {};
        let selectedRoles = {};
        let currentPlayerIndex = 0;

        // --- Seiten-Navigation ---
        function showPage(pageId) {
            document.querySelectorAll('.container').forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
        }

        // --- Startseite Logik ---
        document.getElementById('start-button').addEventListener('click', async () => {
            // Beim Start wird das Spiel im Backend zurückgesetzt
            await fetch(API_BASE_URL + '/api/game/restart', { method: 'POST' });
            showPage('players-page');
            document.getElementById('players-textarea').value = '';
        });

        // --- Spieler-Seite Logik ---
        document.getElementById('to-roles-button').addEventListener('click', async () => {
            const playersString = document.getElementById('players-textarea').value;
            const players = playersString.split('\n').filter(name => name.trim() !== '');

            if (players.length < 4) {
                alert("Es müssen mindestens 4 Spieler angemeldet sein.");
                return;
            }

            await fetch(API_BASE_URL + '/api/game/save_players', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ players: playersString })
            });
            showPage('roles-page');
            loadRolesPage();
        });

        // --- Rollen-Seite Logik ---
        async function loadRolesPage() {
            const rolesListDiv = document.getElementById('roles-list');
            rolesListDiv.innerHTML = '';
            
            const [playersResponse, rolesResponse] = await Promise.all([
                fetch(API_BASE_URL + '/api/game/players'),
                fetch(API_BASE_URL + '/api/game/roles')
            ]);
            
            const playersData = await playersResponse.json();
            const rolesData = await rolesResponse.json();
            
            allPlayers = playersData.players;
            allRolesData = rolesData.all_roles;
            selectedRoles = rolesData.saved_roles;
            
            allRolesData.forEach(role => {
                const count = selectedRoles[role] || 0;
                const roleItem = document.createElement('div');
                roleItem.className = 'roles-list-item';
                roleItem.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <span style="font-size: 1.1em; color: #333;">${role}</span>
                        <button class="info-button" onclick="showInfo('${role}')">i</button>
                    </div>
                    <div>
                        <button onclick="decrementRole('${role}')" style="font-size: 1.2em; padding: 5px 10px; cursor: pointer;">-</button>
                        <span id="${role}-count" style="font-size: 1.2em; margin: 0 10px;">${count}</span>
                        <button onclick="incrementRole('${role}')" style="font-size: 1.2em; padding: 5px 10px; cursor: pointer;">+</button>
                    </div>
                `;
                rolesListDiv.appendChild(roleItem);
            });
            updateRolesToGo();
        }

        function updateRolesToGo() {
            const totalRolesSelected = Object.values(selectedRoles).reduce((a, b) => a + b, 0);
            const remainingRoles = allPlayers.length - totalRolesSelected;
            const rolesToGoSpan = document.getElementById("roles-to-go");
            
            rolesToGoSpan.textContent = remainingRoles;
            rolesToGoSpan.classList.toggle('negative', remainingRoles < 0);
            
            const startButton = document.getElementById('start-game-button');
            if (remainingRoles === 0) {
                startButton.classList.remove('hidden');
            } else {
                startButton.classList.add('hidden');
            }
        }

        function incrementRole(role) {
            if (!selectedRoles[role]) {
                selectedRoles[role] = 0;
            }
            selectedRoles[role]++;
            document.getElementById(role + '-count').textContent = selectedRoles[role];
            updateRolesToGo();
            saveRoles();
        }

        function decrementRole(role) {
            if (selectedRoles[role] > 0) {
                selectedRoles[role]--;
                document.getElementById(role + '-count').textContent = selectedRoles[role];
                updateRolesToGo();
                saveRoles();
            }
        }
        
        async function saveRoles() {
            await fetch(API_BASE_URL + '/api/game/save_roles', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role_counts: selectedRoles })
            });
        }

        document.getElementById('back-to-players').addEventListener('click', () => {
            showPage('players-page');
            // Stelle die Spielernamen wieder her
            fetch(API_BASE_URL + '/api/game/players')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('players-textarea').value = data.players.join('\n');
                });
        });

        document.getElementById('start-game-button').addEventListener('click', async () => {
            const response = await fetch(API_BASE_URL + '/api/game/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role_counts: selectedRoles })
            });
            const result = await response.json();
            if (response.ok) {
                showPage('cards-page');
                loadCardPage();
            } else {
                alert(result.error);
            }
        });

        // --- Karten-Seite Logik ---
        async function loadCardPage() {
            const response = await fetch(API_BASE_URL + '/api/game/next_card');
            const data = await response.json();
            
            if (data.message) {
                showPage('neustart-page');
            } else {
                document.getElementById('player-name').textContent = data.player_name;
                document.getElementById('reveal-role-btn').classList.remove('hidden');
                document.getElementById('role-name').classList.add('hidden');
                document.getElementById('role-description').classList.add('hidden');
                document.getElementById('show-description-btn').classList.add('hidden');
                document.getElementById('next-player-btn').classList.add('hidden');
            }
        }

        document.getElementById('reveal-role-btn').addEventListener('click', async () => {
            const response = await fetch(API_BASE_URL + '/api/game/reveal_and_next', { method: 'POST' });
            const data = await response.json();
            if (response.ok) {
                document.getElementById('role-name').textContent = data.role_name;
                document.getElementById('role-name').classList.remove('hidden');
                document.getElementById('reveal-role-btn').classList.add('hidden');
                document.getElementById('show-description-btn').classList.remove('hidden');
                document.getElementById('next-player-btn').classList.remove('hidden');
            } else {
                alert(data.error);
            }
        });
        
        document.getElementById('show-description-btn').addEventListener('click', async () => {
            const response = await fetch(API_BASE_URL + '/api/game/roles');
            const data = await response.json();
            const roleName = document.getElementById('role-name').textContent;
            const description = data.role_descriptions[roleName];
            if (description) {
                document.getElementById('role-description').textContent = description;
                document.getElementById('role-description').classList.remove('hidden');
                document.getElementById('show-description-btn').classList.add('hidden');
            }
        });
        
        document.getElementById('next-player-btn').addEventListener('click', () => {
            loadCardPage();
        });

        // --- Neustart-Seite Logik ---
        document.getElementById('start-page-btn').addEventListener('click', () => {
            showPage('start-page');
            // Die Logik, die alles im Backend zurücksetzt, ist bereits im Start-Button.
        });

        // --- Rollen-Info Pop-up ---
        function showInfo(roleName) {
            fetch(API_BASE_URL + '/api/game/roles')
                .then(response => response.json())
                .then(data => {
                    const description = data.role_descriptions[roleName];
                    document.getElementById('popup-role-name').textContent = roleName;
                    document.getElementById('popup-role-description').textContent = description;
                    document.getElementById('info-popup').style.display = 'block';
                    document.getElementById('overlay').style.display = 'block';
                });
        }
        
        function hideInfo() {
            document.getElementById('info-popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }
    </script>
</body>
</html>