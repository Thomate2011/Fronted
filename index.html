<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Werwolf Game UI</title>
  <style>
    body {font-family: Arial, sans-serif; margin: 32px; max-width: 700px;}
    textarea, input[type="number"] {font-size: 1em;}
    button {margin:5px; font-size: 1em;}
    .hidden {display:none;}
    .rolle {margin: 2px 0; border-bottom: 1px solid #eee;}
  </style>
</head>
<body>
  <h1>Werwolf Spiel (Frontend Demo)</h1>

  <!-- Spieler -->
  <div id="step-1">
    <h2>Spieler eintragen (jeder in eine neue Zeile):</h2>
    <textarea id="spieler" rows="7" cols="40"></textarea><br>
    <button onclick="nextToRoles()">Weiter</button>
  </div>

  <!-- Rollen -->
  <div id="step-2" class="hidden">
    <h2>Rollen ausw채hlen</h2>
    <div id="roles-list"></div>
    <div>
      <b>Noch verf체gbare Rollen:&nbsp;<span id="roles-missing"></span></b>
    </div>
    <button onclick="startGame()">Mischen & Starten</button>
  </div>

  <!-- Karten-Aufdecken -->
  <div id="step-3" class="hidden">
    <h2>Spielerkarten aufdecken</h2>
    <div id="card-info"></div>
    <button onclick="revealCard()">Karte aufdecken</button>
    <button onclick="nextPlayer()" class="hidden" id="next-btn">N채chster Spieler</button>
  </div>

  <script>
    const BASE = "https://werwolf-game.onrender.com";
    let players = [];
    let roleCounts = {};
    let allRoles = {};
    let currRoleIdx = 0;

    // Schritt 1 -> Schritt 2
    function nextToRoles() {
      const spielerRaw = document.getElementById("spieler").value.trim();
      if (!spielerRaw) return alert("Bitte Namen eingeben!");
      players = spielerRaw.split("\n").map(v => v.trim()).filter(Boolean);
      if (players.length < 4) return alert("Mindestens 4 Spieler!");

      // Lade die Rollen-Legende
      fetch(BASE + "/api/roles/legend")
        .then(r=>r.json()).then(data=>{
          allRoles = data; roleCounts = {};
          // Build Rollenliste
          document.getElementById("roles-list").innerHTML = "";
          Object.keys(allRoles).forEach(role => {
            document.getElementById("roles-list").innerHTML += `
              <div class="rolle">
                <b>${role}</b> 
                <button onclick="changeRole('${role}', -1)">-</button>
                <span id="count_${role}">0</span>
                <button onclick="changeRole('${role}', 1)">+</button> 
                <button onclick="alert('${allRoles[role].replace(/'/g,"\\'")}')">i</button>
              </div>`;
            roleCounts[role] = 0;
          });
          updateRolesMissing();
          document.getElementById("step-1").classList.add("hidden");
		  document.getElementById("step-2").classList.remove("hidden");
        });
    }

    function changeRole(role, delta) {
      let curr = roleCounts[role];
      const sum = Object.values(roleCounts).reduce((a,b)=>a+b,0);

      if (delta > 0 && sum < players.length) {
        roleCounts[role] += 1;
      }
      if (delta < 0 && roleCounts[role] > 0) {
        roleCounts[role] -= 1;
      }
      document.getElementById('count_'+role).textContent = roleCounts[role];
      updateRolesMissing();
    }

    function updateRolesMissing() {
      const sum = Object.values(roleCounts).reduce((a,b)=>a+b,0);
      document.getElementById("roles-missing").textContent = players.length - sum;
    }

    // Schritt 2 -> Spiel starten
    function startGame() {
      const sum = Object.values(roleCounts).reduce((a,b)=>a+b,0);
      if (sum !== players.length) return alert("Nicht exakt so viele Rollen gew채hlt wie Spieler!");
      fetch(BASE + "/api/game/roles", {
        method: "POST",
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({role_counts: roleCounts, players: players, player_count: players.length})
      }).then(r=>r.json()).then(data=>{
        if(data.error) return alert(data.error);
        document.getElementById("step-2").classList.add("hidden");
        document.getElementById("step-3").classList.remove("hidden");
        currRoleIdx = 0;
        showNextPlayer();
      });
    }

    // Karten anzeigen
    function showNextPlayer() {
      fetch(BASE + "/api/game/next_card")
        .then(r=>r.json()).then(data=>{
          if(data.message) { document.getElementById("card-info").textContent = "Fertig!"; return; }
          document.getElementById("card-info").textContent = "Spieler: " + data.player_name;
          document.getElementById("next-btn").classList.add("hidden");
        });
    }
    function revealCard() {
      fetch(BASE + "/api/game/reveal_and_next", {method:"POST"})
        .then(r=>r.json()).then(data=>{
          document.getElementById("card-info").innerHTML = `<b>${data.player_name}</b><br>
           <span style="color:red">${data.role_name}</span><br>`+
           `<span>${data.role_description}</span>`;
          document.getElementById("next-btn").classList.remove("hidden");
        });
    }
    function nextPlayer() { showNextPlayer(); }

  </script>
  <button onclick="location.reload()">Neues Spiel</button>
</body>
</html>