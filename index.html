<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Werwolf-Spiel</title>
<style>
body {font-family: Arial, sans-serif; background: #f2f2f2; margin:0;}
.center-box {
    background:#fff; max-width:600px; margin:32px auto; padding:32px 28px;
    border-radius:16px; box-shadow:0 6px 24px rgba(0,0,0,0.10); 
    text-align: center;
}
h1, h2, h3, p {font-family: Arial, sans-serif; text-align:center;}
textarea, input {font-family: Arial, sans-serif;}
textarea {
    width:96%; font-size:1.07em; border-radius:6px; border:1px solid #aaa;
    padding:8px 2%; margin-top:12px; resize: vertical;
    display: block; margin-left:auto; margin-right:auto; text-align:left;
}
button {
    font-family: Arial, sans-serif;
    font-size:1.08em; margin:9px; padding:10px 26px;
    border-radius:9px; border:none; cursor:pointer; box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    font-weight:500; transition:background 0.2s;
}
button.green {background:#4CAF50; color:#fff;}
button.blue {background:#008CBA; color:#fff;}
button.red {background:#f44336; color:#fff;}
button.gr {background:#888; color:#fff;}
.role-row {
    display:flex; justify-content:center; align-items:center; padding:10px 0;
    border-bottom:1px solid #efefef; font-size:1.1em;
}
.role-name { min-width:140px; font-weight:bold; }
.role-btns {display:flex; align-items:center;}
.info-btn {
    background:#008CBA; color:#fff; border-radius:50%;
    font-weight:bold; width:32px; height:32px; border:none;
    margin-left:13px; font-size:1.17em; line-height:32px; 
    text-align:center; display:inline-flex; align-items:center; justify-content: center;
    box-shadow:0 1px 2px rgba(0,0,0,0.08);
}
.count-round {display:inline-block;min-width:26px;text-align:center;font-size:1.17em;}
#overlay {
    position:fixed; top:0;left:0;width:100vw; height:100vh;
    background:#fff;z-index:10000; display:none;
}
#infobox {
    position:fixed; top:50%; left:50%; width:370px; max-width:95vw; background:#fff; z-index:12000;
    border-radius:13px; padding:36px 28px 24px 28px; box-shadow:0 6px 40px rgba(0,0,0,.17);
    transform:translate(-50%,-50%);
    text-align:center;
}
#infobox h2 {margin-top:0; font-size:2.05em;}
#closeinfo {
    position:absolute; top:10px; right:18px; font-size:2.1em;
    background:none; border:none; color:#444; cursor:pointer; font-family:Arial;
}
.player-row {
    display:flex;justify-content:center;align-items:center; gap:22px; margin:14px 0;
    font-family: Arial, sans-serif;
}
.player-row.dead { color:#888;text-decoration:line-through; font-style:italic;}
@media(max-width:700px){
    .center-box {padding:2vw 3vw}
    #infobox {padding:18px 8px;}
}
</style>
</head>
<body>
<div id="main"></div>
<div id="overlay">
  <div id="infobox">
    <button id="closeinfo">×</button>
    <h2 id="infotitle"></h2>
    <div id="infotext"></div>
  </div>
</div>
<script>
const API = 'https://werwolf-game.onrender.com/api';

let names = [], roleCounts = {}, assignment = {}, who = 0, roletxts = {};

function api(endpoint, data) {
  return fetch(API+endpoint, data ? {
    method: "POST", headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)
  } : undefined).then(r=>r.json());
}
function $(id) { return document.getElementById(id); }

// -------- UI ABSCHNITTE --------
function renderStart() {
  $('main').innerHTML = `<div class="center-box">
    <h1>Willkommen beim Werwolf-Spiel von Thomas</h1>
    <p style="font-size:1.25em; color:#555;">Hier kannst du einfach Rollen für dein Werwolf-Spiel verteilen.</p>
    <hr style="margin:30px auto 32px auto; width:49%;">
    <button class="green" onclick="renderNames()">Zum Spiel</button>
  </div>`;
}
async function renderNames() {
  let nms = await fetch(API+'/names').then(r=>r.json()).then(j=>j.names||[]);
  $('main').innerHTML = `<div class="center-box">
    <h2>Namen eingeben</h2>
    <p>Gib die Namen der Spieler ein (jeder Name in einer neuen Zeile).</p>
    <textarea id="nametxt" rows="8" placeholder="Hier Namen eintragen...">${nms.length?nms.join('\n'):''}</textarea><br>
    <button class="blue" onclick="saveNames()">Zu den Rollen</button>
  </div>`;
}
function saveNames() {
  let nm = $('nametxt').value.split('\n').map(x=>x.trim()).filter(Boolean);
  if(nm.length<4) return alert('Mindestens 4 Namen!');
  api('/names', {names:nm}).then(()=>renderRoles());
}
async function renderRoles() {
  let nms = await fetch(API+'/names').then(r=>r.json()).then(j=>j.names);
  if(!nms || !nms.length) return renderNames(); // Wenn keine Namen, NIE leere Rollenliste!
  let data = await fetch(API+'/roles').then(r=>r.json());
  names = nms; roletxts = data.all_roles||{}; roleCounts = data.role_counts||{};
  // Initialisiere alle Rollen von 0, wenn noch nicht gesetzt
  Object.keys(roletxts).forEach(role=>{
    if(typeof roleCounts[role]!=="number") roleCounts[role]=0;
  });
  let rows = Object.keys(roletxts).map(role=>`
    <div class="role-row">
      <span class="role-name">${role}
        <button class="info-btn" onclick="showInfo('${role}')">i</button>
      </span>
      <span class="role-btns">
        <button onclick="chgRole('${role}',-1)" class="gr">-</button>
        <span class="count-round" id="c_${role.replace(/ /g,'_')}">${roleCounts[role]||0}</span>
        <button onclick="chgRole('${role}',1)" class="gr">+</button>
      </span>
    </div>
  `).join('');
  let sum = Object.values(roleCounts).reduce((a,b)=>a+b,0), miss = names.length - sum;
  $('main').innerHTML = `<div class="center-box">
    <h2>Rollen auswählen</h2>
    <p>Wähle genau ${names.length} Rollen aus.</p>
    <p style="color:#008CBA; font-size:1.22em;">Noch zu vergeben: <span id="miss">${miss}</span></p>
    <div style="margin-bottom:18px;">
      <button class="red" onclick="renderNames()">Zurück</button>
      <button class="green" style="display:${miss===0?'inline-block':'none'}" id="mixbtn" onclick="startMix()">Mischen</button>
    </div>
    <div style="margin:14px 0 14px 0">${rows}</div>
    <div style="margin:12px 0;">
      <button class="green" style="display:${miss===0?'inline-block':'none'}" id="mixbtn2" onclick="startMix()">Mischen</button>
    </div>
  </div>`;
}
function chgRole(role, d) {
  let sum = Object.values(roleCounts).reduce((a,b)=>a+b,0);
  roleCounts[role] = (roleCounts[role]||0) + d;
  if(roleCounts[role]<0) roleCounts[role]=0;
  if(d>0 && sum>=names.length) roleCounts[role]--;
  $('c_'+role.replace(/ /g,'_')).textContent = roleCounts[role];
  let miss = names.length - Object.values(roleCounts).reduce((a,b)=>a+b,0);
  $('miss').textContent = miss;
  api('/roles', {role_counts:roleCounts});
  let show = miss===0?'inline-block':'none';
  if($('mixbtn')) $('mixbtn').style.display=show;
  if($('mixbtn2')) $('mixbtn2').style.display=show;
}
function showInfo(role) {
  $('overlay').style.display = 'block';
  $('infotitle').textContent = role;
  $('infotext').textContent = roletxts[role]||'';
}
$('closeinfo').onclick = ()=>{ $('overlay').style.display='none'; };

async function startMix() {
  let nms = await fetch(API+'/names').then(res=>res.json()).then(j=>j.names||[]);
  let sum = Object.values(roleCounts).reduce((a,b)=>a+b,0);
  if(sum !== nms.length) return alert('Rollenanzahl stimmt nicht!');
  api('/mixroles').then(j=>{ if(j.error)alert(j.error); else renderCards(); });
}

async function renderCards() {
  let resp = await fetch(API+'/next_card').then(r=>r.json());
  if(resp.done) { renderOverview(); return; }
  $('main').innerHTML = `<div class="center-box">
      <h2>Rollen aufdecken</h2>
      <h3 id="pname">${resp.player_name}</h3>
      <div id="roleblock"></div>
      <button class="blue" id="revealbtn" onclick="revealCard()">Rolle aufdecken</button>
    </div>`;
}
function revealCard() {
  api('/reveal_card').then(j=>{
    let b = `<div style="margin:18px 0 13px 0">
      <span style="color:#f44336;font-size:1.34em"><b>${j.role_name||''}</b></span><br>
    </div>
    <button class="blue" onclick="showInfo('${j.role_name}')">Erklärung</button>
    <button class="green" onclick="renderCards()" style="margin-left:18px;">Nächster Spieler</button>`;
    $('roleblock').innerHTML = b;
    $('revealbtn').style.display = 'none';
  });
}

async function renderOverview() {
  let state = await fetch(API+'/status').then(r=>r.json());
  let nms = await fetch(API+'/names').then(r=>r.json()).then(j=>j.names);
  let sum = Object.values(roleCounts).reduce((a,b)=>a+b,0), miss = nms.length - sum;
  let rows = state.map(p =>
    `<div class="player-row${p.status==='dead'?' dead':''}">
      <span style="flex:1;cursor:pointer" onclick="killPlayer('${p.name}')">
        <b>${p.role}</b> | ${p.name}
      </span>
      <button class="info-btn" onclick="showInfo('${p.role}')">i</button>
    </div>`).join('');
  $('main').innerHTML = `<div class="center-box">
    <h2>Spielübersicht</h2>
    <p>Spieler als „tot“ markieren: Klick auf Name</p>
    <div>${rows}</div>
    <div style="margin-top:28px;">
      <button class="red" onclick="resetSoft()">Neustart</button>
      <button class="green" onclick="doInit()" style="margin-left:22px;">Zur Startseite</button>
    </div>
  </div>`;
}

function killPlayer(name) {
  if(!confirm(`Spieler "${name}" als tot markieren?`)) return;
  api('/status', {kill:name}).then(()=>renderOverview());
}
function resetSoft() {
  api('/resetsoft').then(()=>renderRoles());
}
function doInit() {
  api('/init').then(()=>renderStart());
}

// --- Anfang ---
renderStart();
</script>
</body>
</html>